## Divvy Data DIY API

While working with huge CSV files is certainly possible, for online visualization and exploration, it is helpful to have a JSON compatible data api.  The preprocessed files generated by the `DataPreprocessor` can be easily imported into a MySQL database and when used with the PHP API backend, online API queries are trivial.

## Installation

To set up your own Divvy data API, you will need a web server with PHP and MySQL.  Most modern servers, including shared hosting, offer this capability.  To set up the data API follow these steps:

1. Generate the `Divvy_Stations_2013_Preprocessed.csv` and `Divvy_Trips_2013_Preprocessed.csv` (~50MB) files using the `DataPreprocessor`.  
2. On your server, create a MySQL database called `divvy_2013` and a MySQL user called `divvy`.  The `divvy` user should have read access to the `divvy_2013` database (if this doesn't make sense, that's ok, there is an easier alternative below).
3. Next create a table called `Divvy_Stations_2013` in the `divvy_2013` database with using the following structure:

        CREATE TABLE IF NOT EXISTS `Divvy_Stations_2013` (
          `id` int(11) NOT NULL,
          `name` varchar(255) DEFAULT NULL,
          `latitude` float DEFAULT NULL,
          `longitude` float DEFAULT NULL,
          `capacity` int(11) DEFAULT NULL,
          `landmark_id` int(11) DEFAULT NULL,
          `online_date` datetime NOT NULL,
          PRIMARY KEY (`id`)
        ) ENGINE=MyISAM DEFAULT CHARSET=utf8;
        
Import the `Divvy_Stations_2013_Preprocessed.csv` file into this table.

4. Next create a tabled called `Divvy_Trips_2013` in the `divvy_2013` database with the following structure:

        CREATE TABLE IF NOT EXISTS `Divvy_Trips_2013` (
          `trip_id` int(11) NOT NULL,
          `start_time` datetime NOT NULL,
          `stop_time` datetime NOT NULL,
          `bike_id` int(11) NOT NULL,
          `from_station_id` int(11) NOT NULL DEFAULT '-1',
          `to_station_id` int(11) NOT NULL DEFAULT '-1',
          `user_type` varchar(255) DEFAULT NULL,
          `gender` varchar(255) DEFAULT NULL,
          `birth_year` int(11) DEFAULT NULL,
          PRIMARY KEY (`trip_id`),
          KEY `from_station_id` (`from_station_id`),
          KEY `to_station_id` (`to_station_id`),
          KEY `user_type` (`user_type`),
          KEY `stop_time` (`stop_time`),
          KEY `start_time` (`start_time`),
          KEY `birth_year` (`birth_year`)
        ) ENGINE=MyISAM DEFAULT CHARSET=utf8;
        
Import the `Divvy_Trips_2013_Preprocessed.csv` file into this table.  _Note: The `Divvy_Trips_2013_Preprocessed.csv` is quite large and it may not be possible to import the file via a simple interface like phpMyAdmin.  Instead, consider uploading the CSV file to your server, logging in via SSH, changing the name of `Divvy_Trips_2013_Preprocessed.csv` to `Divvy_Trips_2013.csv` and running the following command:

        mysqlimport  --ignore-lines=1 \
        --fields-terminated-by=, \
        --columns='trip_id,start_time,stop_time,bike_id,from_station_id,to_station_id,user_type,gender,birth_year' \
        --local -u root -p divvy_2013 Divvy_Trips_2013.csv
        
5.  Next, upload [api.php](https://github.com/olab-io/divvy_datachallenge_2013_toolkit/blob/master/api/api.php) and [credentials_example.php](https://github.com/olab-io/divvy_datachallenge_2013_toolkit/blob/master/api/credentials_example.php) to the location of your choice on your server.
6.  Rename `credentials_example.php` to `credentials.php` and enter your database location and password.
7.  You are now ready to query the api using the parameters defined below.

## DIY API Queries

The API is currently a single endpoint with a simple set of parameters.  

 Parameter         | Description                        | Example Values                        
:------------------|------------------------------------|:-----------------------------------:
 `start_min`       | _Set the start time range minimum_ |`2013-06-01` or `2013-06-01 12:00:00`     
 `start_max`       | _Set the start time range maximum_ |`2013-06-01` or `2013-06-01 12:00:00`     
 `stop_min`        | _Set the stop time range minimum_  |`2013-06-01` or `2013-06-01 12:00:00`     
 `stop_min`        | _Set the stop time range minimum_  |`2013-06-01` or `2013-06-01 12:00:00`     
 `from_station_id` | _Set the starting station id_      |_See the stations list for valid ids_     
 `to_station_id`   | _Set the ending station id_        |_See the stations list for valid ids_     
 `bike_id`         | _Set the bike id_                  |_See the trips data for valid ids_     
 `trip_id`[^1]     | _Set the trip id_                  |_See the trips data for valid ids_     
 `trip_id_min`[^1] | _Set the minimum trip id_          |_See the trips data for valid ids_     
 `trip_id_max`[^1] | _Set the maximum trip id_          |_See the trips data for valid ids_     
 `user_type`       | _Set the user type_                |`subscriber` or `customer`     
 `gender`          | _Set the user gender_              |`male` or `female`     
 `birth_year`[^2]  | _Set the user birth year_          |_Any year >= 0_     
 `birth_year_min`[^2]| _Set the minimum birth year_     |_Any year >= 0_     
 `birth_year_max`[^2]| _Set the maximum birth year_     |_Any year >= 0_     
 `age`[^2]           | _Set the user age                |_Any age >= 0_     
 `age_min`[^2]       | _Set the minimum age_            |_Any age >= 0_     
 `age_max`[^2]       | _Set the maximum age_            |_Any age >= 0_     
 `page`[^3]          | _The results page_               |_Any page >= 0_     
 `rpp`[^3]           | _Set the maximum age_            |_0 <= rpp <= 100_     
 `callback`          | _A JSONP callback_               |_Any valid javascript method name._

### Examples

For convenience the [openLab](http://olab.io) has established a public endpoint for testing.  The base endpoint URL is:

<http://data.olab.io/divvy/api.php>

_While we will do our best to support public projects, this endpoint may be rate limited without notice if the need arises and users are encouraged to follow the instructions above to establish their own endpoints._

All query parameter strings build from that endpoint.  If you install your own API, your endpoint URL will be different.

Select the first page of 25 results for for trips between 2013-06-01 and 2013-07-01 for males over the age of 50: 
  
  - <http://data.olab.io/divvy/api.php?start_min=2013-06-01&start_max=2013-07-01&gender=male&age_min=50&page=0&rpp=25>

To get results 26 - 50 from the same query:
  
  - <http://data.olab.io/divvy/api.php?start_min=2013-06-01&start_max=2013-07-01&gender=male&age_min=50&page=1&rpp=25>

To get all trips taken by 33 year old females:
  
  - <http://data.olab.io/divvy/api.php?gender=female&age=33>

### Station Data

Static stations are represented in the `stations.json` data.  The `stations.json` data can be generated by the `stations.php` script.  The stations endpoint takes no parameters.

  - <http://data.olab.io/divvy/stations.json>

#### Footnotes
[^1]: If a `trip_id` parameter is passed along with a `trip_id_min` and / or `trip_id_max` parameter, the `trip_id` parameter is ignored and the range style parameters are preferred.
[^2]: Both `age` and `birth_year` select on the same `birth_year` column of the database.  Since it's easier to think in terms of age, when both `age` and `birth_year` parameters are included, all `birth_year` parameters will be ignored in favor of the `age` parameter.  Like `trip_id`, the corresponding range-based versions of the `age` and `birth_year` parameters will be used.

[^3]: Since this is a massive data set, it is not advisable to let a user return huge quantities of data with a single query.  Instead, the trip results are broken down into pages of results.  `rpp` is set to 100 by default and is also the default maximum.  The `page` parameter determines which trip id to begin with.  For instance, to return results starting with the 200th trip, one might pass `rpp=100` and `page=1`. 


### MySQL Tricks

Create a table that includes duration:

```
CREATE VIEW Divvy_Trips_2013_With_Duration AS
SELECT *, (UNIX_TIMESTAMP(stop_time) - UNIX_TIMESTAMP(start_time)) AS duration 
FROM `Divvy_Trips_2013`
```